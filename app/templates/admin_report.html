{% extends "base.html" %}
{% block title %}Generate Reports{% endblock %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
<div class="report-container">

    <!-- Page Title -->
    <div class="header-section">
        <h1><i class="fa-solid fa-chart-bar"></i> Generate Reports</h1>
        <p class="subtitle">Generate detailed attendance reports</p>
    </div>

    <!-- Report Form -->
    <div class="card">
        <div class="card-header">
            <i class="fa-solid fa-cog"></i> Report Configuration
        </div>
        <div class="card-body">
            <form method="POST" class="report-form" id="reportForm">
                {{ form.hidden_tag() }}
                
                <!-- Primary Report Type -->
                <div class="form-group">
                    {{ form.report_scope.label }}
                    {{ form.report_scope(class="form-control") }}
                    {% for error in form.report_scope.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>

                <!-- Dynamic fields based on report scope -->
                <div id="dynamicFields">
                    <!-- Module selection (shown for student and date reports) -->
                    <div class="form-group module-field">
                        {{ form.module_id.label }}
                        {{ form.module_id(class="form-control") }}
                        {% for error in form.module_id.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <!-- Class selection (shown for class reports) -->
                    <div class="form-group class-field">
                        {{ form.class_id.label }}
                        {{ form.class_id(class="form-control") }}
                        {% for error in form.class_id.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <!-- Student selection (shown for student reports) -->
                    <div class="form-group student-field">
                        {{ form.student_id.label }}
                        {{ form.student_id(class="form-control") }}
                        <div id="studentLoadingMsg" style="display: none; color: #1976d2; font-size: 0.9rem; margin-top: 5px;">
                            <i class="fa-solid fa-spinner fa-spin"></i> Loading students...
                        </div>
                        {% for error in form.student_id.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <!-- Date range fields (shown for date range reports) -->
                    <div class="date-range-fields">
                        <div class="form-group">
                            {{ form.date_from.label }}
                            {{ form.date_from(class="form-control") }}
                            {% for error in form.date_from.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="form-group">
                            {{ form.date_to.label }}
                            {{ form.date_to(class="form-control") }}
                            {% for error in form.date_to.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Include all students checkbox (shown for date range reports) -->
                    <div class="form-group include-all-field">
                        <label>
                            {{ form.include_all_students() }}
                            {{ form.include_all_students.label.text }}
                        </label>
                        <small class="form-text">Include all students enrolled in the selected module</small>
                        {% for error in form.include_all_students.errors %}
                            <span class="error-message">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-actions">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>

    <!-- Report Results -->
    {% if report_data is not none %}
    <div class="card">
        <div class="card-header">
            <i class="fa-solid fa-chart-pie"></i> Report Results ({{ report_data|length }} records)
            {% if report_data %}
            <form method="POST" action="{{ url_for('admin_export_report_csv') }}" style="display: inline; margin-left: 20px;">
                <input type="hidden" name="report_scope" value="{{ report_scope }}">
                <input type="hidden" name="class_id" value="{{ form.class_id.data or '' }}">
                <input type="hidden" name="student_id" value="{{ form.student_id.data or '' }}">
                <input type="hidden" name="module_id" value="{{ form.module_id.data or '' }}">
                <input type="hidden" name="date_from" value="{{ form.date_from.data or '' }}">
                <input type="hidden" name="date_to" value="{{ form.date_to.data or '' }}">
                <input type="hidden" name="include_all_students" value="{{ form.include_all_students.data or 'false' }}">
                <button type="submit" class="export-btn">
                    <i class="fa-solid fa-download"></i> Export CSV
                </button>
            </form>
            {% endif %}
        </div>
        <div class="card-body">
            {% if report_data %}
                <!-- Report Summary -->
                <div class="report-summary">
                    <h4>Report Summary</h4>
                    {% if report_scope == 'class' %}
                        {% if filters.class %}
                            <p><strong>Class:</strong> {{ filters.class.module.module_code }} - {{ filters.class.class_type.value }} on {{ filters.class.class_date }}</p>
                        {% endif %}
                    {% elif report_scope == 'student' %}
                        {% if filters.student %}
                            <p><strong>Student:</strong> {{ filters.student.full_name }} ({{ filters.student.student_number }})</p>
                        {% endif %}
                        {% if filters.module %}
                        <p><strong>Module Filter:</strong> {{ filters.module.module_code }} - {{ filters.module.module_name }}</p>
                        {% else %}
                        <p><strong>Module Filter:</strong> All Modules</p>
                        {% endif %}
                    {% elif report_scope == 'date' %}
                        <p><strong>Date Range:</strong> {{ filters.date_from }} to {{ filters.date_to }}</p>
                        {% if filters.module %}
                        <p><strong>Module Filter:</strong> {{ filters.module.module_code }} - {{ filters.module.module_name }}</p>
                            {% if filters.include_all_students %}
                            <p><strong>Scope:</strong> All students enrolled in module</p>
                            {% endif %}
                        {% else %}
                        <p><strong>Scope:</strong> All students within date range</p>
                        {% endif %}
                    {% endif %}
                    <p><strong>Total Records:</strong> {{ report_data|length }}</p>
                </div>

                <!-- Attendance Table -->
                <table class="report-table">
                    <thead>
                        <tr>
                            <th><i class="fa-solid fa-user"></i> Student</th>
                            <th><i class="fa-solid fa-id-card"></i> Student Number</th>
                            <th><i class="fa-solid fa-book"></i> Module</th>
                            <th><i class="fa-solid fa-calendar"></i> Class Date</th>
                            <th><i class="fa-solid fa-clock"></i> Time</th>
                            <th><i class="fa-solid fa-check"></i> Status</th>
                            <th><i class="fa-solid fa-calendar-check"></i> Recorded</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for att in report_data %}
                        <tr>
                            <td>{{ att.student.full_name if att.student else 'N/A' }}</td>
                            <td>{{ att.student.student_number if att.student else 'N/A' }}</td>
                            <td>
                                {% if att.class_session and att.class_session.module %}
                                    {{ att.class_session.module.module_code }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ att.class_session.class_date if att.class_session else 'N/A' }}</td>
                            <td>
                                {% if att.class_session %}
                                    {{ att.class_session.start_time.strftime('%H:%M') if att.class_session.start_time else 'N/A' }} - 
                                    {{ att.class_session.end_time.strftime('%H:%M') if att.class_session.end_time else 'N/A' }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if att.attendance_status.value == "present" %}
                                    <span class="badge success"><i class="fa-solid fa-check"></i> Present</span>
                                {% else %}
                                    <span class="badge danger"><i class="fa-solid fa-xmark"></i> Absent</span>
                                {% endif %}
                            </td>
                            <td>{{ att.timestamp.strftime('%Y-%m-%d %H:%M') if att.timestamp else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
            <div class="empty-state">
                <i class="fa-solid fa-chart-bar fa-3x"></i>
                <h3>No Data Found</h3>
                <p>No attendance records match your current report criteria.</p>
                <p>Try adjusting your filters or check if there are any records available.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>

<style>
.report-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 25px;
    box-sizing: border-box;
}

.header-section {
    text-align: center;
    margin-bottom: 30px;
}

.header-section h1 {
    font-size: 2rem;
    color: #2c3e50;
}

.subtitle {
    color: #7f8c8d;
}

.card {
    background: #fff;
    border-radius: 12px;
    margin-bottom: 25px;
    box-sizing: border-box;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
}

.card-header {
    background: #1976d2;
    color: #fff;
    padding: 12px 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-body {
    padding: 25px;
}

.report-form {
    width: 100%;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
    font-size: 0.9rem;
    display: block;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    box-sizing: border-box;
}

.form-group input[type="checkbox"] {
    width: auto;
    margin-right: 10px;
}

.form-text {
    display: block;
    margin-top: 5px;
    color: #6c757d;
    font-size: 0.8rem;
}

.error-message {
    color: #e74c3c;
    font-size: 0.8rem;
    display: block;
    margin-top: 5px;
}

.date-range-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-actions {
    margin-top: 25px;
    text-align: right;
}

.btn {
    background: #1976d2;
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    background: #1565c0;
    color: #fff;
}

.btn-primary {
    background: #1976d2;
}

.export-btn {
    background: #28a745;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.3s;
}

.export-btn:hover {
    background: #218838;
}

.report-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
    border-left: 4px solid #1976d2;
}

.report-summary h4 {
    margin-top: 0;
    color: #1976d2;
}

.report-summary p {
    margin: 5px 0;
}

.report-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.report-table th,
.report-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    text-align: left;
}

.report-table thead {
    background: #f5f5f5;
}

.report-table th {
    color: #1976d2;
    font-weight: 600;
}

.badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    color: #fff;
}

.badge.success {
    background: #27ae60;
}

.badge.danger {
    background: #e74c3c;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
}

.empty-state i {
    margin-bottom: 15px;
    color: #bdc3c7;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: #2c3e50;
}

.empty-state p {
    margin-bottom: 5px;
    line-height: 1.5;
}

/* Initially hide all dynamic fields */
.module-field,
.class-field,
.student-field,
.date-range-fields,
.include-all-field {
    display: none;
}

@media (max-width: 768px) {
    .report-container {
        padding: 15px;
    }
    
    .card-body {
        padding: 15px;
    }
    
    .date-range-fields {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .report-table {
        font-size: 0.8rem;
    }
    
    .report-table th,
    .report-table td {
        padding: 8px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportScopeSelect = document.getElementById('report_scope');
    const moduleSelect = document.getElementById('module_id');
    const studentSelect = document.getElementById('student_id');
    const moduleField = document.querySelector('.module-field');
    const classField = document.querySelector('.class-field');
    const studentField = document.querySelector('.student-field');
    const dateRangeFields = document.querySelector('.date-range-fields');
    const includeAllField = document.querySelector('.include-all-field');
    const studentLoadingMsg = document.getElementById('studentLoadingMsg');
    
    let isUpdatingStudents = false; // Flag to prevent multiple simultaneous updates
    
    function updateFieldVisibility() {
        // Hide all fields first
        moduleField.style.display = 'none';
        classField.style.display = 'none';
        studentField.style.display = 'none';
        dateRangeFields.style.display = 'none';
        includeAllField.style.display = 'none';
        
        // Show fields based on report scope
        const reportScope = reportScopeSelect.value;
        
        switch(reportScope) {
            case 'class':
                classField.style.display = 'block';
                break;
                
            case 'student':
                moduleField.style.display = 'block';
                studentField.style.display = 'block';
                // Update student options when switching to student scope
                updateStudentOptions();
                break;
                
            case 'date':
                moduleField.style.display = 'block';
                dateRangeFields.style.display = 'grid';
                includeAllField.style.display = 'block';
                break;
        }
    }
    
    function updateStudentOptions() {
        const moduleId = moduleSelect ? moduleSelect.value : 0;
        const reportScope = reportScopeSelect.value;
        
        // Only update student options if we're in student report scope
        if (reportScope !== 'student' || isUpdatingStudents) {
            return;
        }
        
        isUpdatingStudents = true;
        
        // Show loading state
        studentLoadingMsg.style.display = 'block';
        studentSelect.innerHTML = '<option value="">Loading students...</option>';
        studentSelect.disabled = true;
        
        // Fetch enrolled students for the selected module
        fetch(`/admin/get_enrolled_students/${moduleId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(students => {
                studentSelect.innerHTML = '';
                studentSelect.disabled = false;
                studentLoadingMsg.style.display = 'none';
                
                if (!Array.isArray(students) || students.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = moduleId == 0 ? "No students found" : "No students enrolled in this module";
                    studentSelect.appendChild(option);
                } else {
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Select a student";
                    studentSelect.appendChild(defaultOption);
                    
                    // Add student options
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.value;
                        option.textContent = student.text;
                        studentSelect.appendChild(option);
                    });
                }
                
                isUpdatingStudents = false;
            })
            .catch(error => {
                console.error('Error fetching students:', error);
                studentSelect.innerHTML = '<option value="">Error loading students</option>';
                studentSelect.disabled = false;
                studentLoadingMsg.style.display = 'none';
                isUpdatingStudents = false;
            });
    }
    
    // Initial update
    updateFieldVisibility();
    
    // Update on report scope change
    reportScopeSelect.addEventListener('change', function() {
        updateFieldVisibility();
    });
    
    // Update student options when module changes (only for student reports)
    if (moduleSelect) {
        moduleSelect.addEventListener('change', function() {
            if (reportScopeSelect.value === 'student') {
                updateStudentOptions();
            }
        });
    }
    
    // Form submission validation
    document.getElementById('reportForm').addEventListener('submit', function(event) {
        const reportScope = reportScopeSelect.value;
        
        if (reportScope === 'student') {
            const selectedStudent = studentSelect.value;
            const selectedModule = moduleSelect.value;
            
            if (!selectedStudent) {
                event.preventDefault();
                alert('Please select a student for the student report.');
                return false;
            }
            
            // Additional check: if a specific module is selected, ensure student is enrolled
            if (selectedModule && selectedModule !== '0') {
                // This validation will be handled server-side as well
            }
        } else if (reportScope === 'class') {
            const selectedClass = document.getElementById('class_id').value;
            if (!selectedClass) {
                event.preventDefault();
                alert('Please select a class for the class report.');
                return false;
            }
        } else if (reportScope === 'date') {
            const dateFrom = document.getElementById('date_from').value;
            const dateTo = document.getElementById('date_to').value;
            
            if (!dateFrom || !dateTo) {
                event.preventDefault();
                alert('Please select both start and end dates for the date range report.');
                return false;
            }
            
            if (new Date(dateFrom) > new Date(dateTo)) {
                event.preventDefault();
                alert('End date must be after start date.');
                return false;
            }
        }
    });
});
</script>
{% endblock %}